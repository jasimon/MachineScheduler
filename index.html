<html>
  <head>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js'></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.9/d3.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.4/handlebars.min.js"></script>
    <script type="text/javascript" src="/scheduler.js"></script>
    <script type="text/javascript" src="/bootstrap-datepicker.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        Handlebars.registerHelper('moment-toString', function(moment) {
          return moment.format('YYYY-MM-DD hh:mm');
        });
        $('#calendar').fullCalendar({
          header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
          },
        eventLimit:true,
        defaultView: 'month',
        eventClick: function(event, jsEvent, view) {
          $('.event-tooltip').remove();
          var source = $('#event-tooltip-template').html();
          var template = Handlebars.compile(source);
          $('body').append(template(event));
          $('.event-tooltip').css({top:jsEvent.pageY, left:jsEvent.pageX});
          jsEvent.preventDefault();
          console.log(event.start); 
        },
        });

        $('.schedule-event').on('click', function() {
          $('.cover.is-hidden').removeClass('is-hidden');
        })
        $('.cancel-add').on('click', function() {
          $('.cover').addClass('is-hidden');
        })

        $(document).on('click', '.event-tooltip a', function(event) {
          var machineId = $('select.machine-list').find(':selected').val();
          var start = moment.utc($(this).data('start')).format('YYYY-MM-DD hh:mm');
          Scheduler.removeEvent(machineId, start);
          $('.event-tooltip').remove();
          $('#calendar').fullCalendar('removeEvents');
          $('#calendar').fullCalendar('addEventSource', Scheduler.getMachineSchedule(machineId));
        })

        $(document).on('click', function(event) {
          if(!$(event.target).closest('.event-tooltip').length && !event.isDefaultPrevented()) {
            $('.event-tooltip').remove();
          }
        })
        var machines = Scheduler.getMachines();
        for(var i = 0; i < machines.length; i++) {
          $('select.machine-list').append('<option value=' + machines[i] + '>' + machines[i] + '</option>');
        }
        Scheduler.locations.forEach(function(location) {
          $('.location-list').append('<option value=' + location + '>' + location + '</option>')
        });
        Scheduler.types.forEach(function(type) {
          $('.type-list').append('<option value=' + type + '>' + type + '</option>');
        });
        $('select.machine-list').on('change', function(e) {
          $('#calendar').fullCalendar('removeEvents')
          $('#calendar').fullCalendar('addEventSource', Scheduler.getMachineSchedule(this.value));
        })
        $('#calendar').fullCalendar('addEventSource', Scheduler.getMachineSchedule($('select.machine-list').find(':selected').val()));

        $('.start-date').datepicker({format: 'yyyy-mm-dd'});
        $('.end-date').datepicker({format: 'yyyy-mm-dd'});

        $('.add-event').on('click', function() {
          var machineId = $('select.machine-list').find(':selected').val();
          var startDate = $('.start-date').val() + ' ' + $('.start-time').val() + ':00';
          var endDate = $('.end-date').val()  + ' ' + $('.end-time').val() + ':00';
          if (Scheduler.checkOverlap(machineId, startDate, endDate)) {
            alert('Can not have overlapping events');
          } else {
            var location = $('.location-list').find(':selected').val();
            var type = $('.type-list').find(':selected').val();
            Scheduler.addEvent(machineId, startDate, endDate, location, type);
            $('#calendar').fullCalendar('removeEvents');
            $('#calendar').fullCalendar('addEventSource', Scheduler.getMachineSchedule(machineId));
            $('.cover').addClass('is-hidden');
          }
        })
      });
    </script>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.min.css' />
    <link rel="stylesheet" type="text/css" media="print" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.4.0/fullcalendar.print.css"/>
    <link rel="stylesheet" type="text/css" href="/index.css">
    <link rel="stylesheet" type="text/css" href="/datepicker.css">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script id="event-tooltip-template" type="text/x-handlebars-template">
      <div class="event-tooltip">
        <label class="tooltip-title">{{title}}</label>
        <div class="tooltip-row">
          <label>Start:</label>
          <label>{{moment-toString start}}</label>
        </div>
        <div class="tooltip-row">
          <label>End:</label>
          <label>{{moment-toString end}}</label>
        </div>
        <div class="tooltip-row">
          <label>Location:</label>
          <label>{{location}}</label>
        </div>
        <div class="tooltip-row">
          <a data-start={{start}}>Delete Event</a>
        </div>
      </div>
    </script>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <div class="navbar-logo"></div>
        </div>
        <form class="form-inline" role="form">
          <select class="machine-list form-control"></select>
          <button type="button" class="btn btn-primary schedule-event">Schedule Event</button>
        </form>
      </div>
    </nav>
    <div class="calendar-container">
      <div id="calendar"></div>
    </div>
    <div class="cover is-hidden">
      <div class="add-event-popup">
        <h2>Add Event</h2>
        <input type="text" class="start-date"/>
        <input type="number" value="12" class="start-time"/>
        <input class="end-date"/>
        <input type="number" value="13" class="end-time"/>
        <select class="type-list"></select>
        <select class="location-list"></select>
        <button class="add-event">Add Event</button>
        <button class="cancel-add">Cancel</button>
      </div>
    </div>
  </body>
</html>